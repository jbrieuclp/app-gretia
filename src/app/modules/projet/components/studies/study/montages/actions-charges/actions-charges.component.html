<ng-container *ngIf="!loading; else loadingTemplate">
	<table class="table table-bordered table-striped">
		<thead>
			<tr>
				<th> # </th>
				<th> Catégorie </th>
				<th> Intitulé </th>
				<th> Coût unitaire </th>
				<th> Quantité prévue </th>
				<th> Quantité consommée <small>(actuel)</small> </th>
				<th> Total </th>
				<th> Gain/perte <small>(actuel)</small> </th>
			</tr>
		</thead>
		<tbody>
			<ng-container *ngIf="(charges||[]).length; else noData">
				<tr *ngFor="let charge of charges">
					<td>
						<div class="float-left">
							<button 
								*ngIf="charge.removable"
								mat-icon-button 
								color="warn"
								type="button"
								(click)="delete(charge)">
						    <mat-icon>delete</mat-icon>
						  </button>
						</div>
						<div class="float-right">
							<button 
								mat-icon-button 
								color="primary"
								type="button"
								(click)="openFormMontage(charge)"
							>
						    <mat-icon>edit</mat-icon>
						  </button>
						</div>
					</td>
					<td>{{ charge.chargeType?.chargeTypeRef?.label || '-' }}</td>
					<td>
						{{ charge.label }} 
						<mat-icon 
							*ngIf="charge.description"
							[matTooltip]="charge.description"
							position="below"
						>info</mat-icon>
					</td>
					<td>{{ charge.unitCostApplied }}</td>
					<td>{{ charge.quantity }}</td>
					<td
						[ngClass]="charge.chargeType?.chargeTypeRef?.isPerDay && charge.quantityUsed  > charge.quantity ? 'over' : 'not-over'"
					>
						<ng-container *ngIf="!charge.chargeType?.chargeTypeRef?.isPerDay || !loadingUsed; else loaderUsed">
							{{ charge.chargeType?.chargeTypeRef?.isPerDay ? charge.quantityUsed : '-' }}
						</ng-container>

					</td>
					<td>{{ charge.unitCostApplied * charge.quantity }}</td>
					<td
						[ngClass]="charge.chargeType?.chargeTypeRef?.isPerDay && charge.quantityUsed > charge.quantity ? 'over' : 'not-over'"
					>
						<ng-container *ngIf="charge.chargeType?.chargeTypeRef?.isPerDay; else materialTmp">
							<ng-container *ngIf="!loadingUsed; else loaderUsed">
								{{ (charge.quantity - charge.quantityUsed) * charge.unitCostApplied >=0 ? '+' : '-' }}
								{{ (charge.quantity - charge.quantityUsed) * charge.unitCostApplied }}
							</ng-container>
						</ng-container>
						<ng-template #materialTmp>
							0
						</ng-template>
					</td>
				</tr>
			</ng-container>
			<ng-template #noData>
				<tr><td colspan="8">Aucune ligne enregistrée</td></tr>
			</ng-template>
		</tbody>
		<tfoot>
			<tr>
				<th 
					colspan="6" 
					class="table-dark"
				>Total</th>
				<td class="table-dark font-weight-bold">{{ totals }}</td>
				<td 
					class="table-dark font-weight-bold"
					[ngClass]="totalsUsed > totals ? 'over' : 'not-over'"
				>
					<ng-container *ngIf="!loadingUsed; else loaderUsed">
						{{ totalsUsed >=0 ? '+' : '-' }}{{ totalsUsed }}
					</ng-container>
				</td>
			</tr>
		</tfoot>
	</table>

</ng-container>
<ng-template #loadingTemplate>
	<app-loader message="Chargement en cours"></app-loader>
</ng-template>


<ng-template #loaderUsed>
	<mat-progress-bar mode="query"></mat-progress-bar>
</ng-template>



<!-- 	<div class="row">
	<div class="col-md-4">
		<mat-selection-list #actionsList>
		  <mat-list-option 
		  	*ngFor="let action of unfundedActions; let last = last"
		  	[value]="action['@id']"
		  >
		  	<h4 mat-line>{{ action.intitule }}</h4>
    		<p mat-line> {{ action.nbJours }} jour{{ action.nbJours > 1 ? 's' : '' }} </p>
		  </mat-list-option>
		  <mat-divider *ngIf="!last"></mat-divider>
		</mat-selection-list>
	</div>
	<div 
		*ngIf="actionsList.selectedOptions.selected.length"
		class="col-md-4"
	>
		<mat-form-field>
		  <mat-label>Associer à</mat-label>
		  <mat-select
		  	[formControl]="associateChargeForm"
		  	required
		  >
				<mat-option 
					*ngFor="let charge of actionCharges"
					[value]="charge['@id']"
				>
		      {{ charge.label }}
		    </mat-option>
		  </mat-select>
		</mat-form-field>
		<div>
			<button 
				mat-raised-button color="primary"
				(click)="associateChargeActions()"
				[disabled]="!(associateChargeForm.valid && actionsList.selectedOptions.selected.length)"
			>
				Associer
			</button>
			{{(associateChargeForm.valid|json)}}
			{{(actionsList.selectedOptions.selected.length|json)}}
			{{!(associateChargeForm.valid && actionsList.selectedOptions.selected.length)|json}}
		</div>
	</div>
</div> -->
